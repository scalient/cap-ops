# chef-server - Chef Server
#
# Chef Server provides the Chef API server

description "Chef Server API"

start on filesystem
stop on runlevel [!2345]

respawn
respawn limit 5 30

setuid chef
chdir /home/chef/server

<% if respond_to?(:rbenv_version) %>
env RBENV_VERSION=<%= rbenv_version.shellescape %>
<% end %>

pre-start script
    test -x "\
`<% if respond_to?(:rbenv_version) %>rbenv exec<% end %> bundle show chef-server-api`\
/bin/chef-server" || { stop; exit 0; }
end script

script
    prefix=<%= prefix.shellescape %>

    exec <% if respond_to?(:rbenv_version) %>rbenv exec<% end %> bundle exec chef-server \
        -C "${prefix}/etc/chef-server/server.rb" \
        -L "${prefix}/var/log/chef-server/server.log" \
        -e production \
        -p 4000
end script
