cur_dir=$PWD
prefix=<%= prefix.shellescape %>
cache_dir=<%= cache_dir.shellescape %>/chef

export -- BUNDLE_GEMFILE="/home/chef/client/Gemfile"

<% if respond_to?(:rbenv_version) %>
gem="rbenv exec gem"
bundle="rbenv exec bundle"

export -- RBENV_VERSION=<%= rbenv_version.shellescape %>
<% else %>
gem="gem"
bundle="bundle"
<% end %>

########################################################################################################################
# Install APT packages.                                                                                                #
########################################################################################################################

# Update the APT package index, upgrade existing packages, and install the requisite packages.
sudo -- apt-get -qq -- update
sudo -- apt-get -qqy -- upgrade
sudo -- apt-get -qqy -- install build-essential git-core

########################################################################################################################
# Install the Chef client.                                                                                             #
########################################################################################################################

sudo -E -- $gem install bundler

<% if respond_to?(:rbenv_version) %>
sudo -E -- rbenv rehash
<% end %>

chef_create_user /home/chef

chef_install_repo /home/chef/client "git://github.com/carsomyr/cap-ops.git" chef-client

chef_create_dir "${prefix}/etc/chef-client"
chef_create_dir "${prefix}/var/chef-client"
chef_create_dir "${prefix}/var/log/chef-client"

install_file "${cache_dir}/chef-client" "${prefix}/bin"
install_file "${cache_dir}/chef-client.rb" "${prefix}/bin"
install_file "${cache_dir}/client.rb" "${prefix}/etc/chef-client"
install_file "${cache_dir}/validation.pem" "${prefix}/etc/chef-client"

# Install vendorized gems.
sudo -E -u chef -- $bundle install --quiet --path vendor/bundle
